<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let tool = "brush";

const color = document.getElementById("color");
const size = document.getElementById("size");

/* ===== FILE MENU ===== */
const fileMenu = document.getElementById("fileMenu");
const dropdown = document.getElementById("fileDropdown");

fileMenu.onclick = () => {
    dropdown.style.display =
        dropdown.style.display === "block" ? "none" : "block";
};

/* ===== TOOLS ===== */
document.querySelectorAll(".tool").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".tool").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        tool = btn.dataset.tool;
    };
});

/* ===== MOUSE ===== */
canvas.addEventListener("mousedown", e => {
    drawing = true;

    if (tool === "fill") {
        floodFill(e.offsetX, e.offsetY);
        drawing = false;
    }
});

canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

canvas.addEventListener("mousemove", e => {
    if (!drawing) return;

    if (tool === "brush") {
        ctx.fillStyle = color.value;
        ctx.beginPath();
        ctx.arc(e.offsetX, e.offsetY, size.value, 0, Math.PI * 2);
        ctx.fill();
    }

    if (tool === "delete") {
        ctx.clearRect(
            e.offsetX - size.value,
            e.offsetY - size.value,
            size.value * 2,
            size.value * 2
        );
    }
});

/* ===== FLOOD FILL REAL ===== */
function floodFill(startX, startY) {
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = img.data;
    const width = img.width;

    const targetColor = getColorAt(data, startX, startY);
    const fillColor = hexToRGBA(color.value);

    if (colorsMatch(targetColor, fillColor)) return;

    const stack = [[startX, startY]];

    while (stack.length) {
        const [x, y] = stack.pop();
        const index = (y * width + x) * 4;

        if (!colorsMatch(getColorAt(data, x, y), targetColor)) continue;

        setColorAt(data, index, fillColor);

        if (x > 0) stack.push([x - 1, y]);
        if (x < width - 1) stack.push([x + 1, y]);
        if (y > 0) stack.push([x, y - 1]);
        if (y < img.height - 1) stack.push([x, y + 1]);
    }

    ctx.putImageData(img, 0, 0);
}

function getColorAt(data, x, y) {
    const i = (y * canvas.width + x) * 4;
    return [data[i], data[i + 1], data[i + 2], data[i + 3]];
}

function setColorAt(data, i, color) {
    data[i] = color[0];
    data[i + 1] = color[1];
    data[i + 2] = color[2];
    data[i + 3] = 255;
}

function colorsMatch(a, b) {
    return a[0] === b[0] && a[1] === b[1] && a[2] === b[2];
}

function hexToRGBA(hex) {
    return [
        parseInt(hex.substr(1, 2), 16),
        parseInt(hex.substr(3, 2), 16),
        parseInt(hex.substr(5, 2), 16),
        255
    ];
}

/* ===== EXPORT ===== */
document.getElementById("export").onclick = () => {
    const a = document.createElement("a");
    a.download = "paint.png";
    a.href = canvas.toDataURL();
    a.click();
};

/* ===== IMPORT ===== */
const fileInput = document.getElementById("fileInput");

document.getElementById("import").onclick = () => {
    fileInput.click();
};

fileInput.onchange = () => {
    const img = new Image();
    img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = URL.createObjectURL(fileInput.files[0]);
};
</script>
